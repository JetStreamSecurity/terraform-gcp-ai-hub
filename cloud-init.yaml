#cloud-config

package_update: true
package_upgrade: true

write_files:
  - path: /etc/systemd/system/docker-app.service
    content: |
      [Unit]
      Description=Docker Compose Application
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/app
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

  - path: /opt/app/ai-hub.crt
    owner: ubuntu:ubuntu
    permissions: '0644'
    encoding: gz+b64
    content: ${cert_public}

  - path: /opt/app/ai-hub.key
    owner: ubuntu:ubuntu
    permissions: '0600'
    encoding: gz+b64
    content: ${cert_private}

runcmd:
  - sed -i "s/customer-gateway-key-here/${gateway_key}/" /opt/app/.env
  - sed -i 's/\\n/\n/g' /opt/app/ai-hub.crt
  - sed -i 's/\\n/\n/g' /opt/app/ai-hub.key
  - systemctl enable docker-app.service
  - cd /opt/app && docker compose -f docker-compose.yml up -d